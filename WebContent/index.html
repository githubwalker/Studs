<!DOCTYPE html>
<html lang="en">
<head>

    <link href="scripts/jquery-ui-1.11.4/jquery-ui.css" rel="stylesheet" type="text/css" />
    <link href="scripts/jtable.2.4.0/themes/metro/blue/jtable.css" rel="stylesheet" type="text/css" />
    <script src="scripts/jquery-2.2.0.js" type="text/javascript"> </script>
    <script src="scripts/jquery-ui-1.11.4/jquery-ui.js" type="text/javascript"> </script>
    <script src="scripts/jtable.2.4.0/jquery.jtable.js" type="text/javascript"></script>

</head>

<body>
<div id="PeopleTableContainer" style="width: 800px;"></div>

<!-- http://www.codeproject.com/Articles/594874/CRUD-tables-in-WebMatrix-using-jTable-jQuery-plugi -->

<script type="text/javascript">

    // https://mindmup.github.io/editable-table/
    // http://stackoverflow.com/questions/8648892/convert-url-parameters-to-a-javascript-object

    function convert2jsonstring( urlparams_string )
    {
        var js_parsed = urlparams_string
                ?
                JSON.parse('{"' + urlparams_string.replace(/&/g, '","').replace(/=/g,'":"') + '"}',
                        function(key, value) { return key===""?value:decodeURIComponent(value) })
                :
        {}
        ;

        return JSON.stringify( js_parsed );
    }

    $(document).ready(function () {

        $('#PeopleTableContainer').jtable({
            title: 'Table of students',
            paging:true,
            pageSize: 10,
            // sorting: true,
            // defaultSorting: 'PersonId ASC',
            // paging:true,
            actions: {
                listAction: function (postData, jtParams) {
                    console.log("Loading from custom function...");
                    return $.Deferred(function ($dfd) {
                        $.ajax({
                            url: 'rest/students/getPage/' + jtParams.jtStartIndex + '/' + jtParams.jtPageSize,
                            type: 'POST',
                            dataType: 'json',
                            data: postData,
                            success: function (data) {
                                $dfd.resolve(data);
                            },
                            error: function () {
                                $dfd.reject();
                            }
                        });
                    });
                },                /*
                listAction: function (postData) {
                    console.log('listAction has been called...');
                    var json_string = convert2jsonstring(postData);
                },
                */
                createAction: function (postData) {
                    console.log('createAction has been called...');
                    var json_string = convert2jsonstring(postData);

                    return $.Deferred(function ($dfd) {
                        $.ajax({
                            url: 'rest/students/append',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            type: 'POST',
                            dataType: 'json',
                            data: json_string,
                            success: function (data) {
                                console.log('createAction success ...');
                                $dfd.resolve(data);
                            },
                            error: function () {
                                console.log('createAction error ...');
                                $dfd.reject();
                            }
                        });
                    });
                },
                updateAction: function (postData) {
                    console.log('updateAction has been called...');
                    var json_string = convert2jsonstring(postData);
                    var stud = JSON.parse( json_string );

                    return $.Deferred(function ($dfd) {
                        $.ajax({
                            url: 'rest/students/update/' + stud.PersonId,
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            type: 'POST',
                            dataType: 'json',
                            data: json_string,
                            success: function (data) {
                                console.log('updateAction success ...');
                                $dfd.resolve(data);
                            },
                            error: function () {
                                console.log('updateAction error ...');
                                $dfd.reject();
                            }
                        });
                    });
                },
                deleteAction: function (postData) {
                    console.log('updateAction has been called...');

                    return $.Deferred(function ($dfd) {
                        $.ajax({
                            url: 'rest/students/delete/' + postData.PersonId,
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            type: 'POST',
                            dataType: 'json',
                            success: function (data) {
                                console.log('deleteAction success ...');
                                $dfd.resolve(data);
                            },
                            error: function () {
                                console.log('deleteAction error ...');
                                $dfd.reject();
                            }
                        });
                    });
                }

            },
            fields: {
                PersonId: {
                    title: 'Student Id',
                    key: true,
                    create: false,
                    edit: false,
                    list: true
                },
                Name: {
                    title: 'Student Name',
                    width: '40%'
                },
                Age: {
                    title: 'age',
                    width: '20%'
                }
            }
        });

        //Load person list from server
        $('#PeopleTableContainer').jtable('load');

    });

</script>

</body>
</html>
